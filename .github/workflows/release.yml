name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  version-and-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
      release_id: ${{ steps.create-release.outputs.id }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        id: bump
        run: |
          # Get current version
          CURRENT=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT"

          # Bump version
          npm version ${{ inputs.bump }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "New version: $NEW_VERSION"

          # Update Cargo.toml
          sed -i 's/^version = ".*"/version = "'$NEW_VERSION'"/' src-tauri/Cargo.toml

          # Update tauri.conf.json
          sed -i 's/"version": ".*"/"version": "'$NEW_VERSION'"/' src-tauri/tauri.conf.json

          # Update CHANGELOG.md - move [Unreleased] content to new version
          TODAY=$(date +%Y-%m-%d)

          node -e "
            const fs = require('fs');
            let changelog = fs.readFileSync('CHANGELOG.md', 'utf8');

            // Extract content between [Unreleased] and next version header
            const match = changelog.match(/## \[Unreleased\]\s*([\s\S]*?)(?=\n## \[|$)/);
            const unreleasedContent = match ? match[1].trim() : '';

            if (!unreleasedContent || unreleasedContent === '(No changes yet)') {
              console.error('ERROR: No changes in [Unreleased] section. Update CHANGELOG.md before releasing.');
              process.exit(1);
            }

            // Create new version section
            const newSection = '## [$NEW_VERSION] - $TODAY\n\n' + unreleasedContent;

            // Replace [Unreleased] content with empty and insert new version
            changelog = changelog.replace(
              /## \[Unreleased\]\s*[\s\S]*?(?=\n## \[)/,
              '## [Unreleased]\n\n\n' + newSection + '\n\n'
            );

            fs.writeFileSync('CHANGELOG.md', changelog);

            // Output changelog for release notes
            fs.writeFileSync('/tmp/release_notes.md', unreleasedContent);
            console.log('Changelog updated successfully');
          ".replace(/\$NEW_VERSION/g, "$NEW_VERSION").replace(/\$TODAY/g, "$TODAY")

          # Save release notes for later
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Commit and tag
          git add package.json package-lock.json src-tauri/Cargo.toml src-tauri/tauri.conf.json CHANGELOG.md
          git commit -m "chore(release): v$NEW_VERSION"
          git tag "v$NEW_VERSION"
          git push origin main --tags

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.bump.outputs.version }}
          name: Watson v${{ steps.bump.outputs.version }}
          body: |
            ## Watson v${{ steps.bump.outputs.version }}

            A fast, cross-platform productivity launcher.

            ### What's New

            ${{ steps.bump.outputs.release_notes }}

            ### Installation

            Download the appropriate file for your platform:
            - **Windows**: `.msi` or `.exe`
            - **macOS**: `.dmg`
            - **Linux**: `.deb` or `.AppImage`

            ---
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for full history.
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    needs: version-and-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
          - platform: macos-latest
            target: aarch64-apple-darwin
          - platform: macos-13
            target: x86_64-apple-darwin
          - platform: windows-latest
            target: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: v${{ needs.version-and-release.outputs.version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.version-and-release.outputs.release_id }}
          args: --target ${{ matrix.target }}
          updaterJsonPreferNsis: true

  publish:
    needs: [version-and-release, build]
    runs-on: ubuntu-latest
    steps:
      - name: Publish release
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ needs.version-and-release.outputs.release_id }},
              draft: false
            });
